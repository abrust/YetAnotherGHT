{
	"name": "Dedicated - Create External Table for Flights",
	"properties": {
		"folder": {
			"name": "Workshop"
		},
		"content": {
			"query": "-- Create master key\nCREATE MASTER KEY ENCRYPTION BY PASSWORD='BoobooBooboo!';\n\n-- Create database scoped credential object with SAS for needed ADLS container \nCREATE DATABASE SCOPED CREDENTIAL FlightsCred\nWITH IDENTITY='SHARED ACCESS SIGNATURE',  \nSECRET = 'sv=2020-02-10&st=2023-11-08T23%3A48%3A54Z&se=2025-11-09T23%3A48%3A00Z&sr=d&sp=rl&sig=oeAvbsYaQg9zNxyXyPNN2yo%2Blx90Py4HgQn%2BCy4IQVw%3D&sdd=1'\n\n-- Create external data source object for corresponding ADLS container and account\nCREATE EXTERNAL DATA SOURCE BlueBadge\nWITH \n  (LOCATION = 'abfss://bluebadgegen2fs@bluebadgegen22sa.dfs.core.windows.net',\n  CREDENTIAL = FlightsCred)\n\n-- Create external file format object for Parquet data\nCREATE EXTERNAL FILE FORMAT BBIParquet\nWITH (\n  FORMAT_TYPE = PARQUET\n  )\n\n-- Create the external table\nCREATE EXTERNAL TABLE FlightDataExternal(\n    [Year] INT,\n    [Month] INT,\n    DayofMonth INT,\n    DayOfWeek INT,\n    DepTime VARCHAR(8000),\n    CRSDepTime VARCHAR(8000),\n    ArrTime VARCHAR(8000),\n    CRSArrTime VARCHAR(8000),\n    NASDelay VARCHAR(8000),\n    SecurityDelay VARCHAR(8000),\n    LateAircraftDelay VARCHAR(8000),\n    IsArrDelayed BIT,\n    IsDepDelayed BIT,\n    TaxiOut INT,\n    Cancelled BIT,\n    CancelledCode VARCHAR(8000),\n    Diverted BIT,\n    CarrierDelay VARCHAR(8000),\n    WeatherDelay VARCHAR(8000),\n    ArrDelay INT,\n    DepDelay INT,\n    Origin VARCHAR(8000),\n    Destination VARCHAR(8000),\n    Distance INT,\n    TaxiIn INT,\n    UniqueCarrier VARCHAR(8000),\n    FlightNum VARCHAR(8000),\n    TailNum VARCHAR(8000),\n    ActualElapsedTime INT,\n    CRSElapsedTime INT,\n    AirTime INT\n)\nWITH (\n  LOCATION = '/flightonefile',\n  DATA_SOURCE = BlueBadge,\n  FILE_FORMAT = BBIParquet\n)\n\n-- Check row count in external table\nSELECT COUNT(*) FROM FlightDataExternal\n\n-- Query external table\nSELECT Year, Month, COUNT(*) FROM FlightDataExternal GROUP BY Year, Month ORDER BY Year, Month\n\n-- Uncomment and run code block below ony if internal tables not already created\n/* Create Internal table and drop auto-created CCI\nSELECT \n    [Year], \n    [Month],\n    DayofMonth,\n    DayOfWeek,\n    DepTime,\n    CRSDepTime,\n    ArrTime,\n    CRSArrTime,\n    NASDelay,\n    SecurityDelay,\n    LateAircraftDelay,\n    TaxiOut,\n    CancelledCode,\n    CarrierDelay,\n    WeatherDelay,\n    ArrDelay,\n    DepDelay,\n    Origin,\n    Destination,\n    Distance,\n    TaxiIn,\n    UniqueCarrier,\n    FlightNum,\n    TailNum,\n    ActualElapsedTime,\n    CRSElapsedTime,\n    AirTime\nINTO FlightDataInternalCCI\nFROM FlightDataExternal\n\n-- 1. To create external table with CCI, set table name above to FlightDataInternalCCI\n-- and note CCI created by defulat\n-- 2. To create external table with *no* CCI, set table name above to FlightDataInternal \n-- and *drop* CCI created by default, as below\nDROP INDEX ClusteredIndex_<autogenerated suffix> ON FlightDataInternal\n*/\n\n-- Query internal table, with no index\nSELECT Year, Month, COUNT(*), SUM(ArrDelay) FROM FlightDataInternal WHERE Year = 2006 GROUP BY Year, Month ORDER BY Year, Month\n\n-- Query internal table, with unordered CCI\nSELECT Year, Month, COUNT(*), SUM(ArrDelay) FROM FlightDataInternalCCI WHERE Year = 2006 GROUP BY Year, Month ORDER BY Year, Month\n \n-- Query internal table, with ordered CCI\n--CREATE CLUSTERED COLUMNSTORE INDEX FlightDataCCI ON FlightDataInternal ORDER (Year, Month) --WITH (DROP_EXISTING = ON)\n--SELECT Year, Month, COUNT(*) FROM FlightDataInternal GROUP BY Year, Month ORDER BY Year, Month\n--DROP INDEX FlightDataCCI ON FlightDataInternal\n\n-- Drop objects to clean up \n\n-- Uncomment the two lines below only if you want to rebuild the internal tables again\n--DROP TABLE FlightDataInternal\n--DROP TABLE FlightDataInternalCCI\n\nDROP EXTERNAL TABLE FlightDataExternal\nDROP EXTERNAL FILE FORMAT BBIParquet\nDROP EXTERNAL DATA SOURCE BlueBadge\nDROP DATABASE SCOPED CREDENTIAL FlightsCred2\nDROP MASTER KEY",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "SampleSQL",
				"poolName": "SampleSQL"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}